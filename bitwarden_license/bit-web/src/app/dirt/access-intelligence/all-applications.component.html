<!-- Risk Insights First Report Prompt -->
@if (showFirstReportPromptDialog) {
  <!-- Modal backdrop -->
  <div
    class="tw-fixed tw-bg-black tw-bg-opacity-30 tw-inset-0 tw-z-50 tw-flex tw-items-center tw-justify-center tw-p-4"
    (click)="closePrompt()"
    cdkTrapFocus
    cdkTrapFocusAutoCapture
  >
    <!-- Modal container - prevent click propagation -->
    <div
      (click)="$event.stopPropagation()"
      class="tw-flex tw-justify-center tw-max-h-[90vh] tw-overflow-y-auto"
    >
      <bit-simple-dialog class="!tw-w-auto !tw-max-w-4xl" hideIcon="true">
        <span bitDialogTitle>Welcome to Risk insights</span>
        <span bitDialogContent>
          <div class="tw-text-left">
            <p class="tw-text-muted tw-mb-6 tw-text-center">
              To get started, follow these steps to find potential security risks.
            </p>

            <div class="tw-space-y-4">
              <div
                class="tw-bg-background-alt tw-p-4 tw-rounded-lg tw-border tw-border-solid tw-border-secondary-100"
              >
                <h3 class="tw-font-semibold tw-text-main tw-mb-2">
                  1. Enforce organization data ownership
                  <span class="tw-text-muted tw-font-normal">(recommended)</span>
                </h3>
                <p class="tw-text-muted tw-leading-relaxed">
                  Turn on the
                  <a
                    href="https://bitwarden.com/help/policies/#enforce-organization-data-ownership"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="tw-text-primary-600 tw-underline hover:tw-text-primary-700 tw-cursor-pointer"
                    >enforce organization data ownership policy</a
                  >
                  to get complete visibility of all organization vault data. This setting can be
                  enabled at any time.
                </p>
              </div>
              <div
                class="tw-bg-background-alt tw-p-4 tw-rounded-lg tw-border tw-border-solid tw-border-secondary-100"
              >
                <h3 class="tw-font-semibold tw-text-main tw-mb-2">2. Run the report</h3>
                <p class="tw-text-muted tw-leading-relaxed">
                  Run the report to see a detailed view of potential at-risk passwords across your
                  most critical applications.
                </p>
              </div>
            </div>
          </div>
        </span>
        <ng-container bitDialogFooter>
          <button bitButton buttonType="primary" type="button" (click)="runReport()">
            Run Report
          </button>
        </ng-container>
      </bit-simple-dialog>
    </div>
  </div>
}

@if (dataService.isLoading$ | async) {
  <tools-risk-insights-loading></tools-risk-insights-loading>
} @else {
  @if (dataService.drawerDetails$ | async; as drawerDetails) {
    <div class="tw-mt-4" *ngIf="!dataSource.data.length">
      <bit-no-items [icon]="noItemsIcon" class="tw-text-main">
        <ng-container slot="title">
          <h2 class="tw-font-semibold tw-mt-4">
            {{
              "noAppsInOrgTitle"
                | i18n: (dataService.organizationDetails$ | async)?.organizationName
            }}
          </h2>
        </ng-container>
        <ng-container slot="description">
          <div class="tw-flex tw-flex-col tw-mb-2">
            <span class="tw-text-muted">
              {{ "noAppsInOrgDescription" | i18n }}
            </span>
            <a class="tw-text-primary-600" routerLink="/login">{{ "learnMore" | i18n }}</a>
          </div>
        </ng-container>
        <ng-container slot="button">
          <button (click)="goToCreateNewLoginItem()" bitButton buttonType="primary" type="button">
            {{ "createNewLoginItem" | i18n }}
          </button>
        </ng-container>
      </bit-no-items>
    </div>
    <div class="tw-mt-4 tw-flex tw-flex-col" *ngIf="dataSource.data.length">
      <h2 class="tw-mb-6" bitTypography="h2">{{ "allApplications" | i18n }}</h2>
      <div class="tw-flex tw-gap-6">
        <dirt-card
          #allAppsOrgAtRiskMembers
          class="tw-flex-1 tw-cursor-pointer"
          [ngClass]="{
            'tw-bg-primary-100': drawerDetails.invokerId === 'allAppsOrgAtRiskMembers',
          }"
          [title]="'atRiskMembers' | i18n"
          [value]="applicationSummary.totalAtRiskMemberCount"
          [maxValue]="applicationSummary.totalMemberCount"
          (click)="showOrgAtRiskMembers('allAppsOrgAtRiskMembers')"
        >
        </dirt-card>
        <dirt-card
          #allAppsOrgAtRiskApplications
          class="tw-flex-1 tw-cursor-pointer"
          [ngClass]="{
            'tw-bg-primary-100': drawerDetails.invokerId === 'allAppsOrgAtRiskApplications',
          }"
          [title]="'atRiskApplications' | i18n"
          [value]="applicationSummary.totalAtRiskApplicationCount"
          [maxValue]="applicationSummary.totalApplicationCount"
          (click)="showOrgAtRiskApps('allAppsOrgAtRiskApplications')"
        >
        </dirt-card>
      </div>
      <div class="tw-flex tw-mt-8 tw-mb-4 tw-gap-4">
        <bit-search
          [placeholder]="'searchApps' | i18n"
          class="tw-grow"
          [formControl]="searchControl"
        ></bit-search>
        <button
          type="button"
          [buttonType]="'primary'"
          bitButton
          [disabled]="!selectedUrls.size"
          [loading]="markingAsCritical"
          (click)="markAppsAsCritical()"
        >
          <i class="bwi tw-mr-2" [ngClass]="selectedUrls.size ? 'bwi-star-f' : 'bwi-star'"></i>
          {{ "markAppAsCritical" | i18n }}
        </button>
      </div>

      <app-table-row-scrollable
        [dataSource]="dataSource"
        [showRowCheckBox]="true"
        [showRowMenuForCriticalApps]="false"
        [selectedUrls]="selectedUrls"
        [openApplication]="drawerDetails.invokerId"
        [checkboxChange]="onCheckboxChange"
        [showAppAtRiskMembers]="showAppAtRiskMembers"
      ></app-table-row-scrollable>
    </div>
  }
}
